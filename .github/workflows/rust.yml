on: [push]

name: CI

jobs:
  build-example:
  runs-on: ubuntu-latest
  steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Build
      run: echo ${{ github.sha }} > Release.txt
    - name: Test
      run: cat Release.txt
    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: Release.txt
  x64_build:
    name: Build x64 Rust Binaries
    runs-on: ubuntu-18.04
    env:
      SQLX_OFFLINE: "true"
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - run: sudo apt-get install lld libbsd-dev protobuf-compiler
      - name: x64 Build
        uses: actions-rs/cargo@v1
        # if: startsWith(github.ref, 'refs/tags/')
        with:
          command: build
          # args: --release
      - name: x64 Release
        uses: softprops/action-gh-release@v1
        # if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ./target/debug/teg-invite
            ./target/debug/teg-marlin
            ./target/debug/teg-server
            ./target/debug/teg-health-monitor
          # cp ./snapcraft/webrtc-server
  arm_v7_build:
    name: Build ARMv7 Rust Binaries
    runs-on: ubuntu-18.04
    env:
      SQLX_OFFLINE: "true"
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: armv7-unknown-linux-gnueabihf
      - run: sudo apt-get install lld libbsd-dev protobuf-compiler
      - name: ARMv7 Build
        uses: actions-rs/cargo@v1
        # if: startsWith(github.ref, 'refs/tags/')
        with:
          command: build
          args: --release --target=armv7-unknown-linux-gnueabihf
      - name: ARMv7 Release
        uses: softprops/action-gh-release@v1
        # if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ./target/armv7-unknown-linux-gnueabihf/release/teg-invite
            ./target/armv7-unknown-linux-gnueabihf/release/teg-marlin
            ./target/armv7-unknown-linux-gnueabihf/release/teg-server
            ./target/armv7-unknown-linux-gnueabihf/release/teg-health-monitor
          # cp ./snapcraft/webrtc-server
